function [Y,Xf,Af] = sample_300_network(X,~,~)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 03-Sep-2016 16:11:17.
%
% [Y] = myNeuralNetworkFunction(X,~,~) takes these arguments:
%
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = Qx60 matrix, input #1 at timestep ts.
%
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = Qx3 matrix, output #1 at timestep ts.
%
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [0.5;-13.625;-27.9375;-3.8;-3.34;-2.44;4;-13.4375;-31.0625;-8.09;-5.35;-2.99;1.875;-12.4375;-85.875;-8.9;-5.75;-4.36;0.6875;-12.75;-112.375;-9.77;-5.36;-6.73;4.125;-14.4375;-109.25;-9.3;-7.91;-7.42;6.1875;-12.9375;-117.1875;-7.23;-8.67;-16.55;1.375;-13.1875;-118.4375;-4.64;-6.55;-11.23;1.125;-13.3125;-117.9375;-3;-5.5;-4.74;1;-14.4375;-117.75;-1.57;-9.04;-5.19;0.1875;-14.1875;-118;-1.47;-2.55;-2.02];
x1_step1.gain = [0.0056547093125994;0.108108108108108;0.0371660859465738;0.386100386100386;0.361663652802893;0.523560209424084;0.00566772936592278;0.109965635738832;0.0359955005624297;0.208116545265349;0.229357798165138;0.306278713629403;0.00566371681415929;0.117647058823529;0.0137221269296741;0.190657769304099;0.140056022408964;0.186046511627907;0.00567275305796845;0.0946745562130177;0.00951814396192742;0.117370892018779;0.141743444365698;0.174064403829417;0.00562291337199086;0.0848806366047745;0.00920069005175388;0.0803535556448373;0.115740740740741;0.175746924428823;0.00566973777462792;0.0935672514619883;0.00862998921251348;0.098135426889107;0.134138162307176;0.094921689606075;0.00563876651982379;0.08;0.00849482346694983;0.101677681748856;0.172413793103448;0.113186191284663;0.00561009817671809;0.0822622107969152;0.00860677783754707;0.151285930408472;0.210748155953635;0.24390243902439;0.00559049615653389;0.0806045340050378;0.00866973719859117;0.185528756957328;0.164880461665293;0.116346713205352;0.00557200069650009;0.0829015544041451;0.00868149755832881;0.205128205128205;0.252206809583859;0.293685756240822];
x1_step1.ymin = -1;

% Layer 1
b1 = [-1.5492776815002729;-1.220675022234152;0.94562302027034228;1.0026376044904715;-0.51859668281003179;0.2884843744014679;-0.31296160411079715;1.6059720720232997;-1.0536417380226966;1.198692391134748];
IW1_1 = [0.26774275079011167 0.10152298380152433 -0.0017217340115865604 0.2842221328745535 0.056986588567643055 -0.0080270818434578905 -0.045760620919933138 -0.18843021426622261 -0.36399691111551957 -0.14154368224199773 -0.11334627404198505 0.25647645427622012 -0.09506963022464883 0.24390364218140545 0.14227596739267331 0.069971526604341597 0.2464173347531641 -0.032141937448596287 0.037099413866382679 0.10460155545793647 0.18937698255490265 0.066133304837102377 0.2852259167493133 -0.052541734942529915 0.087317338617278223 0.28264349234452241 -0.34163530679860216 0.35146388874057244 0.22138329150647068 -0.4020118222915034 -0.22422809879694636 0.11268035926521333 0.23466666288950744 -0.21258572782685442 0.066418678517723304 0.14369131781576486 0.15305562804756376 -0.057882859262469666 -0.32326209428889424 0.085713264146292045 0.084948897840793236 -0.078489171667385185 0.064090549624543067 -0.22776152309537395 0.053090223669389328 0.13742326113828865 0.20307259883424678 0.005519658478213574 -0.012673727196095944 -0.025992234932066215 0.018256040193137403 0.10749581483602905 0.19492296476262125 -0.068209540262157101 0.14006781487391529 -0.35874554501323552 0.26003728772579826 0.0059718872885188273 -0.15775955413720802 0.2511923636097636;0.21608690197679387 -0.13996084868772235 0.26057073059636038 0.052348752290974354 0.054482962987859852 0.098172960148933203 0.043702353299319457 0.39343591166950476 0.28472268109756643 0.11909113547186323 0.025140012896361297 0.17417858538559292 -0.040180725106526344 -0.19260331093629987 -0.26315655018091172 0.24348731907027976 0.0012875542298978974 -0.25303825660918972 -0.18608526693638647 0.20947812061970564 -0.48729692767567773 0.026807150944309868 0.085671551464549203 0.074938669743796552 0.018719872724798726 -0.34788527117726475 -0.64436286383709329 0.17165303126278986 0.13894346077770381 0.1889135522566863 0.18938954615931661 -0.055941616690439913 -0.39540717321255975 -0.10842632823392243 -0.091944734954382226 -0.24801204054299064 -0.014891003288968925 0.21645164136512904 -0.77608876821122463 0.12897059029863528 0.25098449014768287 -0.15228431095314984 -0.24744156471528991 -0.13316817064082306 -0.36253096550193165 -0.32170010427949813 -0.2265364652067991 0.078696844252814757 0.17083060774145178 -0.0042975532759132766 -0.85725838339384519 0.010596072659028096 -0.1962957974665715 0.12199386505171604 -0.25717258802737758 -0.37274200855356687 -0.55107528523265881 -0.11160350320276585 0.056498067496772934 -0.19580694276671651;-0.14377360925884278 -0.029337879189398713 0.37302858722461002 0.12286402790860529 0.23530256916815451 0.29580765121968772 -0.15610710081374471 -0.015897859459291491 0.31113896611786757 -0.35508279859292385 -0.093988445061233342 0.045341356578270563 -0.19359391652423161 -0.12236962059749379 0.10373228661032369 -0.19669557823335093 -0.24213479718345399 0.23103102682725432 0.32820291720984179 -0.10956775545483971 0.11725478440399893 -0.18236039862805944 -0.2507389702534959 0.21487722079540425 0.3266145638519084 0.033401239883740816 -0.30472163423012588 0.074523084816582999 -0.2560988674700162 -0.091265867498374592 -0.081448912801637866 0.14297372685495263 -0.6339516221514877 0.0066749173370056012 0.23085654998449945 0.13677707970726102 0.19587256090630306 0.13254839203905081 -0.72853194605507132 -0.028255712483163803 -0.03766136087126179 0.012239599328383505 -0.030404380848417088 -0.21010476374648515 -0.72877889186085665 0.23034511848420636 -0.054048687376188315 -0.050360209994330017 0.15449337003881816 0.33538392263106837 -0.86807156493505122 0.060366241337300577 0.18709532994547701 -0.15071950011180396 -0.12121237256694702 0.25948841176976811 -0.55088008306714975 0.27987342445734142 -0.2931181247583845 -0.24621166501024477;-0.072891896430551939 0.01760754785278654 0.037181096759883812 -0.079152023214926731 -0.13452477096795146 0.056408300268710389 -0.021238576144301219 0.22560126695190952 0.048595293348104113 -0.1708988245173709 -0.26839386732081505 0.17430498854458099 -0.31912370119120276 -0.24206770077227746 -0.1131749604925814 -0.16130990241625751 0.19493017807088875 -0.18221685386506217 0.21510456511627729 -0.27167554379045661 0.38510596262918922 -0.16031649517283356 -0.14730050465288325 0.38552212894487797 -0.035724937022888682 -0.1523494034241574 0.25598278335260083 -0.25776722486649123 -0.075562109586919779 0.032138096855969175 -0.14499975076691116 0.15312039666613486 0.66309476130110767 -0.28502107916724084 0.19225959448884297 0.015497490670606958 0.06393849877311103 0.18448103858522574 0.74585600482267411 0.021458025330056221 0.0049486000965349147 0.36936937150519972 0.015537882857490155 -0.10279266431539151 1.1008849862607009 0.035040671383176708 -0.10125724506288879 0.33450967540757393 0.13142441694662518 -0.026582216314082086 1.1693248227651161 -0.26759936436873716 0.20838116934886469 0.095686428868536511 -0.095525300707411706 0.13316451434993404 1.2085709996087821 -0.33232919060680149 0.0004418858634103592 -0.018815872851507997;-0.093134870645184123 0.12049079364782907 -0.15605630546341825 0.10598161213957318 0.19807047932657221 -0.23285462929481307 -0.21112172709252286 -0.16008448730701022 -0.5241726396259383 0.58148739136950989 -0.18310943418487874 -0.31735383615868695 0.28770401636883303 0.032945952859649838 -0.17829212094160693 0.3992874167952285 0.62892761028476385 -0.26936468623381643 -0.095238085899969183 -0.079782930708893848 0.14625284253567106 0.53790326120592791 -0.019695871028417453 -0.087877628286656018 0.051329361540666675 0.38344831629788229 0.62879460020437961 0.28015932556527035 0.045700828376114264 -0.50999619348281133 -0.00128892837457017 -0.25741286022114773 0.50653882635044156 0.087480546673799092 0.017631710701048312 -0.47237444774614268 0.044139535954178293 0.095699310180921204 0.56871920950478227 -0.34797180035969155 -0.019206816159242981 -0.39904560671893902 -0.29986185366407908 0.092105780247479702 0.44031487489400978 -0.08395352439951817 0.089285007477711328 -0.15096212676652404 0.25179255351680679 -0.31284448521137243 0.47373103935339128 -0.23387570749297593 -0.08082824781779914 0.55081848231398589 0.10695059796557535 -0.64208535454620419 0.97804708905405835 -0.038689282466526476 0.31389458015232991 0.1991770337413559;0.067947817127774451 -0.2233563069200156 -0.26515210201316147 -0.341181537670047 0.11547710975028731 0.077284251283043948 0.055709203671049978 0.19626869462482358 -0.079609412583868944 -0.21769151512916182 -0.29799355874995692 0.34372677551189268 0.25806640588407098 -0.0092007418620947169 0.087539232892839325 -0.29620120231190611 -0.08599459667990296 -0.13428456204634576 -0.3036305165610545 -0.24217858701142986 0.018924827155570353 -0.27480944053864376 0.091328524882364134 0.030584787370474899 0.18977942626663952 0.090835085679800642 0.14641889532446811 0.15792370722316129 -0.020119452074283881 -0.090453565919911952 0.2452247042656161 -0.2095093438282189 0.26722835265079364 -0.053290475169665945 -0.097421907862105292 -0.03840400025710896 -0.34778707680651416 -0.088870710703403327 -0.017339990722904923 0.34039333421364698 -0.34913560117435022 0.25404032289590533 0.1235593145808677 0.094640552115298954 -0.27695941887257847 0.46516572496351244 0.17323111196574137 -0.28618530336498821 0.28152685780933712 0.23474169717606197 -0.061087197991292107 0.040174929732903285 0.2559196601996484 -0.25196662924141366 0.18611400126524349 0.15900995121825034 0.29956636084202709 0.26006807754811623 0.17610062949916502 0.020614703990766862;0.16763978585234135 -0.1108941787520137 -0.4054172189240095 0.35105259969777097 0.005848445587416479 -0.57923099667888045 0.17180060367069247 -0.44973669168393932 -0.36505478903951277 0.27199920934607436 -0.17440410795887454 -0.26327921716707842 0.075843732122536062 0.048263880400805467 0.11310529787737686 0.58623318603867425 0.51685955365885539 -0.27529273575519281 -0.16017247081907746 0.067609601348404227 0.0060779391673698282 0.38154893201430029 0.0037462716161599753 -0.28872983044357248 0.24637500786053895 0.070012390645719985 0.661039478732383 0.12913576441272531 0.16906639105839438 -0.47760683714790275 -0.028900835705657796 0.36855066591516761 0.4462291950898058 -0.064222151277237696 -0.11111548699263821 -0.70734338115447026 -0.30619111896362999 -0.19447016083832261 0.76886041589176479 -0.12438862300591386 -0.077910492830454384 -0.27953011575252068 -0.18975475204583611 -0.13589273507400115 0.91419550910893854 -0.52554000429947123 -0.21190735134265071 -0.20233735105481451 -0.23222917224218864 -0.11293916924284815 1.0118856969421297 -0.21255282984198506 -0.39445297883622177 0.6869382849414184 0.19242862079681317 -0.71083239346994065 0.55677209038070941 0.05918112758190941 0.50925559663305586 0.26981706931873956;0.14584773119192418 -0.096746367902448838 -0.27822169961331988 -0.40069777202491624 0.008551207471346918 0.16461445201508632 0.10332838627381817 0.015184966542634078 0.14865538891666336 -0.5856246884876749 -0.16014037796721753 0.07288743802253185 -0.33751497180700119 -0.10422978292268935 -0.12398843000330383 -0.44365420605026601 -0.19567589933865434 0.054244348774643146 -0.10846036262196891 -0.092391466952648438 0.13032052025235524 -0.37187664471498494 -0.00541673868094035 0.27724416056515355 -0.01545506875097238 0.026324039464261224 0.040706408686979556 -0.70056118864976658 0.090494901419597346 0.41989125500623298 0.25856785550801153 -0.060604102975660878 0.66306767734756666 0.10604084831092107 -0.095757987108365625 0.36692648857070448 -0.11646119840426138 0.016692495010771621 0.8069541459354217 0.049633056237356941 -0.02629654516794171 0.14535878829468529 0.2982311929014847 0.06823994566657457 0.61831404675730328 0.51894100102230412 0.41715707985086792 -0.072914806223383768 -0.19068460270404602 0.21019266532896866 0.58602049257871636 -0.029219533091751057 0.32968635262822737 -0.044465258856328169 -0.058743129245196854 0.26824207603043759 0.89102721186491851 0.32174727008565324 0.15516723388347112 0.20945189255586119;-0.22623840946692403 0.29868109000585008 0.28708512804363007 -0.23074411699527997 -0.23469044636828129 -0.20495437903279948 -0.10909088235278562 -0.14820417789267068 -0.0082504640883944054 0.15229260177789591 -0.082729870136968697 0.27911254792540224 -0.25264637469683837 0.11879216518202459 0.27716649934220328 -0.11689430239369317 -0.25892006155324071 -0.12220747897310152 -0.0047271576234912197 -0.22759863303866343 0.24873748834501322 -0.60564702706117235 -0.26377068449984531 -0.23130141519779268 -0.28644729117339268 -0.22977900651465091 0.022599520415116831 -0.46079137028815542 -0.15625513388844905 0.45285822769819883 -0.21030545829631653 -0.28233342150190677 0.012115544256354922 -0.25390294211372266 0.30206767884498975 0.059386051470703333 -0.046970206270228076 0.12864047624116121 -0.066139686798493622 -0.0041277177970705662 0.33795223620977649 -0.13091749321146462 -0.21549089324124202 0.058270655383810523 -0.095721541263940238 0.40817083597672554 0.074809684495795212 -0.030188334588901605 0.082286778108433253 -0.068888894961612449 0.091596417890487225 0.4879841127485553 0.29363937824846192 -0.10974304666053389 -0.023471961601237691 0.40921212317011924 -0.0070187351532423718 0.43271842722362497 0.18836239806896918 0.26066861491232768;0.038624883836319755 -0.1137940469972975 -0.13271812861142607 0.24304125992816836 -0.33440665936610325 0.095306897221657472 -0.32729038536051425 0.36280958071845154 0.26663933870201939 0.11987426733401221 -0.3808975868591204 -0.096652579139982417 -0.14543489985612115 -0.083462277266929716 0.086334294031540665 -0.014256772367077989 -0.11598356620420473 0.28029586379214649 -0.20433633318677955 -0.11150262331062669 -0.11374596076230199 0.34606567433768254 0.10370495509822686 0.077047759857826956 -0.2112813416037104 0.10304099229118645 -0.21611221414254803 -0.025276507735782862 -0.068193935924848875 0.18046617260641212 0.094733391643959164 -0.064493431867116216 -0.38592489417977066 -0.17758702061927084 0.24976314082038978 -0.42478580168523422 0.047060192074682421 -0.14153724676722504 -0.037010224784859429 -0.20349037281841745 -0.32672044233053132 0.084819387965013662 0.11938241715852438 -0.014924528088246113 -0.24391519064884509 0.073642902666389509 0.055373716467930267 -0.10228074905175566 -0.33523775807415601 -0.40526499974232477 -0.42724994051747228 0.11360003334102109 0.17497709799799854 0.32092558375302016 -0.33829706005663074 -0.14112378054391692 -0.019816401666419778 0.25087847474879565 0.11221890626351912 0.11895894673457605];

% Layer 2
b2 = [-1.0723965643255042;-0.62344192429018264;-0.47573953266029034];
LW2_1 = [-0.64048053449229858 -1.7390678808730342 0.60856722190255874 1.3621758618453017 -1.9762120171301305 0.86212641608028684 -2.5453201088462225 2.1823445305164126 1.2053962893277148 -0.78184410232725376;0.037859314114001646 1.2476834495600893 0.32257565800599924 -4.111546398260387 -0.48394902796983597 -0.71942787083977067 -0.74911510449683194 -2.7101693614942906 -0.30569453702074045 1.0989485607570135;-0.37914698531594954 -1.0453896401238645 -2.9809572217715936 1.4832155409020604 2.4914141918402288 -0.18249807618120906 3.2290106661569271 0.23319102478905909 -0.65506105721886543 -0.84514477058340987];

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX, X = {X}; end;

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
    Q = size(X{1},1); % samples/series
else
    Q = 0;
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS
    
    % Input 1
    X{1,ts} = X{1,ts}';
    Xp1 = mapminmax_apply(X{1,ts},x1_step1);
    
    size(IW1_1*Xp1)
    size(IW1_1)
    size(Xp1)
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    size(a1)
    
    % Layer 2
    a2 = softmax_apply(repmat(b2,1,Q) + LW2_1*a1);
    
    % Output 1
    Y{1,ts} = a2;
    Y{1,ts} = Y{1,ts}';
end

% Final Delay States
Xf = cell(1,0);
Af = cell(2,0);

% Format Output Arguments
if ~isCellX, Y = cell2mat(Y); end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Competitive Soft Transfer Function
function a = softmax_apply(n,~)
if isa(n,'gpuArray')
    a = iSoftmaxApplyGPU(n);
else
    a = iSoftmaxApplyCPU(n);
end
end
function a = iSoftmaxApplyCPU(n)
nmax = max(n,[],1);
n = bsxfun(@minus,n,nmax);
numerator = exp(n);
denominator = sum(numerator,1);
denominator(denominator == 0) = 1;
a = bsxfun(@rdivide,numerator,denominator);
end
function a = iSoftmaxApplyGPU(n)
nmax = max(n,[],1);
numerator = arrayfun(@iSoftmaxApplyGPUHelper1,n,nmax);
denominator = sum(numerator,1);
a = arrayfun(@iSoftmaxApplyGPUHelper2,numerator,denominator);
end
function numerator = iSoftmaxApplyGPUHelper1(n,nmax)
numerator = exp(n - nmax);
end
function a = iSoftmaxApplyGPUHelper2(numerator,denominator)
if (denominator == 0)
    a = numerator;
else
    a = numerator ./ denominator;
end
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end
